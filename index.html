<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jurnal Guru - Shidqia</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="manifest" id="pwa-manifest-link"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#4f46e5">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .active-tab {
            @apply text-indigo-600;
        }
        .active-tab svg {
            @apply text-indigo-600 fill-current;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            @apply ring-2 ring-indigo-500 border-indigo-500;
        }
        .page-view {
            transition: opacity 0.2s ease-in-out;
        }
        .hidden-view {
            display: none;
            opacity: 0;
        }
        .form-select, .form-input {
            @apply w-full bg-gray-50 border-2 border-gray-100 rounded-2xl p-4 text-sm font-semibold text-gray-700 focus:bg-white transition-all;
        }
    </style>
</head>
<body class="safe-bottom">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
            <p class="text-indigo-600 mt-4 font-semibold tracking-wide">SHIDQIA JURNAL</p>
        </div>
    </div>

    <!-- Login Container -->
    <section id="login-container" class="min-h-screen flex items-center justify-center p-6 bg-white hidden">
        <div class="w-full max-sm:max-w-xs mx-auto">
            <div class="text-center mb-10">
                <div class="w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-4 overflow-hidden shadow-lg border-4 border-indigo-50">
                    <img src="https://quizizz.com/_media/quizzes/a9d2f653-3f07-4f73-9ed8-74aa87668a7d" alt="Logo Shidqia" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/200/4f46e5/ffffff?text=SJ'">
                </div>
                <h2 class="text-3xl font-extrabold text-gray-900">Selamat Datang</h2>
                <p class="text-gray-500 mt-2">Masuk dengan ID Guru Shidqia Anda</p>
            </div>

            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">ID GURU (6 DIGIT)</label>
                    <input type="text" id="id-guru-input" maxlength="6" pattern="\d{6}" required placeholder="000000" class="w-full bg-gray-50 border-gray-200 border-2 rounded-2xl p-4 text-center text-2xl font-bold tracking-[0.5em] focus:bg-white transition-all">
                </div>

                <div id="login-history-container" class="hidden">
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-2">ID Terakhir:</p>
                    <div id="login-history-list" class="flex flex-wrap gap-2"></div>
                </div>

                <button type="submit" id="login-button" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 active:scale-[0.98] transition-all flex items-center justify-center">
                    <span id="login-text">Masuk</span>
                    <div id="login-spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-3"></div>
                </button>
                <div id="login-error" class="text-red-500 text-sm text-center hidden font-medium"></div>
            </form>
        </div>
    </section>

    <!-- App Container -->
    <div id="app-container" class="hidden pb-24">
        <!-- Header -->
        <header class="p-6 pb-2">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Halo, selamat bekerja!</p>
                    <h2 id="user-display-name" class="text-2xl font-bold text-gray-900">...</h2>
                </div>
                <button id="logout-button" class="p-2 bg-red-50 text-red-500 rounded-xl active:scale-95 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- VIEW: Dashboard (Beranda) -->
        <section id="view-home" class="page-view p-6 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="bg-indigo-50 w-10 h-10 rounded-xl flex items-center justify-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <p class="text-xs text-gray-400 font-bold uppercase">Bulan Ini</p>
                    <h3 id="stat-count-month" class="text-2xl font-black text-gray-900 mt-1">0</h3>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <div class="bg-emerald-50 w-10 h-10 rounded-xl flex items-center justify-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <p class="text-xs text-gray-400 font-bold uppercase tracking-tight">Hari Ini</p>
                    <h3 id="stat-count-today" class="text-2xl font-black text-gray-900 mt-1">0</h3>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-800 mb-4">Aktivitas Terakhir</h3>
                <div id="home-recent-list" class="space-y-4">
                    <p class="text-center text-sm text-gray-400 py-4">Memuat riwayat...</p>
                </div>
                <button onclick="switchView('history')" class="w-full mt-4 text-indigo-600 font-bold text-sm py-2">Lihat Semua Riwayat</button>
            </div>
        </section>

        <!-- VIEW: Riwayat -->
        <section id="view-history" class="page-view hidden-view p-6 space-y-6">
            <h2 class="text-2xl font-bold text-gray-900">Riwayat Jurnal</h2>
            
            <div class="flex gap-2">
                <select id="filter-bulan" class="flex-1 form-select !p-3">
                    <option value="01">Januari</option><option value="02">Februari</option>
                    <option value="03">Maret</option><option value="04">April</option>
                    <option value="05">Mei</option><option value="06">Juni</option>
                    <option value="07">Juli</option><option value="08">Agustus</option>
                    <option value="09">September</option><option value="10">Oktober</option>
                    <option value="11">November</option><option value="12">Desember</option>
                </select>
                <input type="number" id="filter-tahun" class="w-24 form-input !p-3 text-center">
            </div>

            <div id="journal-list-content" class="space-y-4">
                <!-- Riwayat Rendered -->
            </div>
        </section>

        <!-- VIEW: Ekspor -->
        <section id="view-export" class="page-view hidden-view p-6 space-y-6">
            <h2 class="text-2xl font-bold text-gray-900">Ekspor Laporan</h2>
            <div class="bg-indigo-50 p-5 rounded-3xl border border-indigo-100">
                <p class="text-indigo-800 text-sm font-medium leading-relaxed">Pilih periode laporan untuk diunduh. Jika unduhan otomatis tidak muncul, rekap akan dibuka di tab baru untuk disalin.</p>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Pilih Bulan</label>
                    <select id="bulan-export" class="form-select">
                        <option value="01">Januari</option><option value="02">Februari</option>
                        <option value="03">Maret</option><option value="04">April</option>
                        <option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option>
                        <option value="09">September</option><option value="10">Oktober</option>
                        <option value="11">November</option><option value="12">Desember</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2 block">Tahun</label>
                    <input type="number" id="tahun-export" class="form-input text-center">
                </div>
                <div class="grid grid-cols-1 gap-3 pt-4">
                    <button id="export-html-button" class="bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-100 flex items-center justify-center space-x-2 active:scale-95 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Ekspor ke Word (HTML)</span>
                    </button>
                    <button id="export-text-button" class="bg-gray-100 text-gray-700 font-bold py-4 rounded-2xl flex items-center justify-center space-x-2 active:scale-95 transition-transform">
                        <span>Ekspor Teks (.txt)</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- MODAL: Input Jurnal Baru -->
        <div id="modal-input" class="fixed inset-0 z-50 flex items-end justify-center hidden">
            <div class="absolute inset-0 bg-black/40 backdrop-blur-[2px]" onclick="closeInputModal()"></div>
            <div class="relative w-full max-w-lg bg-white rounded-t-[40px] shadow-2xl p-8 max-h-[90vh] overflow-y-auto transform translate-y-full transition-transform duration-300 ease-out" id="modal-content">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                <h2 class="text-2xl font-extrabold text-gray-900 mb-6">Jurnal Baru</h2>
                
                <form id="journal-form" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Tanggal</label>
                            <input type="date" id="tanggal" required class="form-input !p-3">
                        </div>
                        <div class="col-span-1">
                            <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Kegiatan</label>
                            <select id="kegiatan" required class="form-select !p-3">
                                <option value="" disabled selected>Pilih...</option>
                                <option value="Mengajar">Mengajar</option>
                                <option value="Piket">Piket</option>
                                <option value="Seminar/Workshop">Seminar</option>
                                <option value="Mengisi Nilai/Raport">Nilai/Raport</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>

                    <div id="teaching-fields" class="hidden space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-1">
                                <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Mulai Jam</label>
                                <select id="jam-mulai" class="form-select !p-3">
                                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                    <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                                    <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                                </select>
                            </div>
                            <div class="col-span-1">
                                <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Selesai Jam</label>
                                <select id="jam-selesai" class="form-select !p-3">
                                    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                                    <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                                    <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                                    <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Kelas</label>
                            <select id="kelas" class="form-select !p-3">
                                <option value="" disabled selected>Pilih Kelas</option>
                                <optgroup label="Kelas 7">
                                    <option value="7 Mekkah">7 Mekkah</option><option value="7 Madinah">7 Madinah</option>
                                    <option value="7 Thaif">7 Thaif</option><option value="7 Riyadh">7 Riyadh</option>
                                    <option value="7 Jeddah">7 Jeddah</option>
                                </optgroup>
                                <optgroup label="Kelas 8">
                                    <option value="8 Alexandria">8 Alexandria</option><option value="8 Abu Dhabi">8 Abu Dhabi</option>
                                    <option value="8 Andalusia">8 Andalusia</option><option value="8 Istanbul">8 Istanbul</option>
                                    <option value="8 Casablanca">8 Casablanca</option><option value="8 Cordova">8 Cordova</option>
                                    <option value="8 Sevilla">8 Sevilla</option>
                                </optgroup>
                                <optgroup label="Kelas 9">
                                    <option value="9 Qatar">9 Qatar</option><option value="9 Kuwait">9 Kuwait</option>
                                    <option value="9 Albania">9 Albania</option><option value="9 Bosnia">9 Bosnia</option>
                                    <option value="9 Maroko">9 Maroko</option><option value="9 Tunish">9 Tunish</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Materi Pembelajaran</label>
                            <input type="text" id="materi" placeholder="Contoh: Operasi Hitung" class="form-input !p-3">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Absensi (S/I/A)</label>
                            <input type="text" id="kehadiran" placeholder="Contoh: Andi (S), Budi (I)" class="form-input !p-3">
                        </div>
                    </div>

                    <div id="piket-fields" class="hidden">
                        <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Lokasi Lantai</label>
                        <select id="lantai" class="form-select !p-3">
                            <option value="Lantai 1">Lantai 1</option><option value="Lantai 2">Lantai 2</option>
                            <option value="Lantai 3">Lantai 3</option><option value="Lantai 4">Lantai 4</option>
                        </select>
                    </div>

                    <div id="other-fields" class="hidden">
                        <label class="text-xs font-bold text-gray-400 mb-2 block tracking-widest uppercase">Nama Kegiatan</label>
                        <input type="text" id="nama-kegiatan-lainnya" placeholder="Deskripsikan kegiatan..." class="form-input !p-3">
                    </div>

                    <button type="submit" id="submit-button" class="w-full bg-indigo-600 text-white font-bold py-5 rounded-3xl shadow-xl shadow-indigo-100 flex items-center justify-center active:scale-95 transition-transform">
                        <span id="submit-text">Simpan Sekarang</span>
                        <div id="submit-spinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin ml-3"></div>
                    </button>
                </form>
            </div>
        </div>

        <!-- Floating Action Button -->
        <button onclick="openInputModal()" class="fixed right-6 bottom-24 bg-indigo-600 text-white w-16 h-16 rounded-3xl shadow-2xl shadow-indigo-400 flex items-center justify-center active:scale-90 transition-transform z-40">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4" />
            </svg>
        </button>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 glass-nav h-20 border-t border-gray-100 flex items-center justify-around z-40 px-4">
            <button onclick="switchView('home')" id="nav-home" class="flex flex-col items-center justify-center w-full active-tab">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <span class="text-[10px] font-bold mt-1 uppercase tracking-tighter">Beranda</span>
            </button>
            <button onclick="switchView('history')" id="nav-history" class="flex flex-col items-center justify-center w-full text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-[10px] font-bold mt-1 uppercase tracking-tighter">Riwayat</span>
            </button>
            <button onclick="switchView('export')" id="nav-export" class="flex flex-col items-center justify-center w-full text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                <span class="text-[10px] font-bold mt-1 uppercase tracking-tighter">Ekspor</span>
            </button>
        </nav>
    </div>

    <!-- MODAL ALERT CUSTOM -->
    <div id="custom-modal-alert" class="fixed inset-0 z-[200] flex items-center justify-center p-6 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative bg-white w-full max-w-sm rounded-[32px] p-8 shadow-2xl text-center">
            <h3 id="modal-alert-title" class="text-xl font-extrabold text-gray-900 mb-2">Pesan</h3>
            <p id="modal-alert-message" class="text-gray-500 mb-8 text-sm leading-relaxed"></p>
            <button onclick="closeAlertModal()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg shadow-indigo-100 active:scale-95 transition-transform">Tutup</button>
        </div>
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, deleteDoc, Timestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Konfigurasi Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBrNuO3WIgBiyHZDE3_7YeZFb6382Psmqg",
            authDomain: "jurnal-harian-guru-1b4cd.firebaseapp.com",
            projectId: "jurnal-harian-guru-1b4cd",
            storageBucket: "jurnal-harian-guru-1b4cd.firebasestorage.app",
            messagingSenderId: "944268886074",
            appId: "1:944268886074:web:c9ba2e81524464754a7503",
            measurementId: "G-TVKVZBYEZQ"
        };

        const GOOGLE_SHEET_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbxGPe_5m6kxaCrmFR2ib6YyNjwBzEgWxoXYKnLPiGFIahW_D9BWPQUsF0aDZwPZfyE1/exec'; 
        const appIdPrefix = typeof __app_id !== 'undefined' ? __app_id : 'jurnal-guru-shidqia';

        let app, db, auth, firebaseUid = null; 
        let currentUserIdGuru = null, currentUserName = null;
        let journalDataCache = [];

        // Global Utility: Show Modal Alert
        window.showAlert = (title, message) => {
            document.getElementById('modal-alert-title').textContent = title;
            document.getElementById('modal-alert-message').textContent = message;
            document.getElementById('custom-modal-alert').classList.remove('hidden');
        };

        window.closeAlertModal = () => {
            document.getElementById('custom-modal-alert').classList.add('hidden');
        };

        // UI View Switcher
        window.switchView = (target) => {
            const views = ['home', 'history', 'export'];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                const nav = document.getElementById(`nav-${v}`);
                if (v === target) {
                    el.classList.remove('hidden-view');
                    if(nav) nav.classList.add('active-tab');
                } else {
                    el.classList.add('hidden-view');
                    if(nav) nav.classList.remove('active-tab');
                }
            });
        };

        window.openInputModal = () => {
            const modal = document.getElementById('modal-input');
            const content = document.getElementById('modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('translate-y-full'), 10);
            document.getElementById('tanggal').valueAsDate = new Date();
        };

        window.closeInputModal = () => {
            const modal = document.getElementById('modal-input');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        // Memulai Aplikasi
        async function start() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        await signInAnonymously(auth);
                    } else {
                        firebaseUid = user.uid;
                        checkSession();
                    }
                });
            } catch (e) {
                console.error("Firebase Error", e);
            }
        }

        function checkSession() {
            const storedId = localStorage.getItem('jurnalGuruId');
            if (storedId) {
                currentUserIdGuru = storedId;
                currentUserName = localStorage.getItem('jurnalGuruName');
                setupApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            renderLoginHistory();
        }

        function setupApp() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display-name').textContent = currentUserName;

            const now = new Date();
            document.getElementById('filter-tahun').value = now.getFullYear();
            document.getElementById('tahun-export').value = now.getFullYear();
            document.getElementById('filter-bulan').value = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('bulan-export').value = String(now.getMonth() + 1).padStart(2, '0');

            setupRealtimeListener();
            setupExportListeners();
        }

        function renderLoginHistory() {
            const history = JSON.parse(localStorage.getItem('jurnalGuruHistory') || '[]');
            const list = document.getElementById('login-history-list');
            if (history.length > 0) {
                document.getElementById('login-history-container').classList.remove('hidden');
                list.innerHTML = '';
                history.forEach(id => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = "bg-gray-50 border border-gray-100 text-gray-700 px-4 py-2 rounded-xl text-xs font-bold active:bg-indigo-600 active:text-white";
                    btn.textContent = id;
                    btn.onclick = () => { document.getElementById('id-guru-input').value = id; };
                    list.appendChild(btn);
                });
            }
        }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('id-guru-input').value;
            const btn = document.getElementById('login-button');
            const spinner = document.getElementById('login-spinner');
            const txt = document.getElementById('login-text');

            btn.disabled = true;
            spinner.classList.remove('hidden');
            txt.textContent = 'Memverifikasi...';

            try {
                const res = await fetch(`${GOOGLE_SHEET_WEBHOOK_URL}?id=${id}`);
                const data = await res.json();
                if (data.verified) {
                    currentUserIdGuru = data.id;
                    currentUserName = data.name;
                    localStorage.setItem('jurnalGuruId', data.id);
                    localStorage.setItem('jurnalGuruName', data.name);
                    
                    let history = JSON.parse(localStorage.getItem('jurnalGuruHistory') || '[]');
                    if (!history.includes(id)) {
                        history.unshift(id);
                        localStorage.setItem('jurnalGuruHistory', JSON.stringify(history.slice(0, 5)));
                    }
                    setupApp();
                } else {
                    showAlert("ID Salah", "ID Guru tidak ditemukan.");
                }
            } catch {
                showAlert("Error", "Koneksi gagal. Cek internet.");
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
                txt.textContent = 'Masuk';
            }
        });

        document.getElementById('logout-button').onclick = () => {
            if(confirm("Keluar dari aplikasi?")) {
                localStorage.removeItem('jurnalGuruId');
                localStorage.removeItem('jurnalGuruName');
                window.location.reload();
            }
        };

        document.getElementById('kegiatan').onchange = (e) => {
            const v = e.target.value;
            document.getElementById('teaching-fields').classList.toggle('hidden', v !== 'Mengajar');
            document.getElementById('piket-fields').classList.toggle('hidden', v !== 'Piket');
            document.getElementById('other-fields').classList.toggle('hidden', v !== 'Lainnya');
        };

        document.getElementById('journal-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!firebaseUid) return;

            const btn = document.getElementById('submit-button');
            const spinner = document.getElementById('submit-spinner');
            const txt = document.getElementById('submit-text');

            btn.disabled = true;
            spinner.classList.remove('hidden');
            txt.textContent = 'Menyimpan...';

            try {
                const keg = document.getElementById('kegiatan').value;
                const data = {
                    tanggal: document.getElementById('tanggal').value,
                    kegiatan: keg,
                    timestamp: Timestamp.now()
                };

                if (keg === 'Mengajar') {
                    data.jamMulai = document.getElementById('jam-mulai').value;
                    data.jamSelesai = document.getElementById('jam-selesai').value;
                    data.kelasDiajar = document.getElementById('kelas').value;
                    data.materiDiajar = document.getElementById('materi').value;
                    data.kehadiranPesertaDidik = document.getElementById('kehadiran').value;
                } else if (keg === 'Piket') {
                    data.lantai = document.getElementById('lantai').value;
                } else if (keg === 'Lainnya') {
                    data.namaKegiatanLainnya = document.getElementById('nama-kegiatan-lainnya').value;
                }

                const userPath = `/artifacts/${appIdPrefix}/users/${firebaseUid}/jurnal_harian`;
                await addDoc(collection(db, userPath), data);
                
                const sheetData = {
                    Tanggal: data.tanggal,
                    Kegiatan: keg,
                    'Kelas Diajar': data.kelasDiajar || '',
                    'Jam Ke': (data.jamMulai && data.jamSelesai) ? `${data.jamMulai}-${data.jamSelesai}` : '',
                    'Materi Diajar': data.materiDiajar || '',
                    'Kehadiran Peserta Didik': data.kehadiranPesertaDidik || '',
                    'Keterangan Lainnya': keg === 'Piket' ? data.lantai : (keg === 'Lainnya' ? data.namaKegiatanLainnya : '')
                };
                
                fetch(GOOGLE_SHEET_WEBHOOK_URL, { 
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({...sheetData, 'Nama Guru': currentUserName, 'ID Guru': currentUserIdGuru, 'Waktu Simpan': new Date().toLocaleString()})
                });

                closeInputModal();
                document.getElementById('journal-form').reset();
                showAlert("Berhasil", "Jurnal telah tersimpan dan dikirim.");
            } catch (e) {
                console.error("Save error", e);
                showAlert("Error", "Gagal menyimpan. Cek koneksi.");
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
                txt.textContent = 'Simpan Sekarang';
            }
        };

        function setupRealtimeListener() {
            if (!firebaseUid) return;
            const userPath = `/artifacts/${appIdPrefix}/users/${firebaseUid}/jurnal_harian`;
            const q = query(collection(db, userPath));
            
            onSnapshot(q, (snap) => {
                let arr = [];
                snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
                
                arr.sort((a, b) => {
                    const tA = a.timestamp?.seconds || 0;
                    const tB = b.timestamp?.seconds || 0;
                    return tB - tA;
                });
                
                journalDataCache = arr;
                updateStats();
                renderRecentDashboard();
                renderHistory();
            });
        }

        function updateStats() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const curMonth = String(now.getMonth() + 1).padStart(2, '0');
            const curYear = now.getFullYear();

            const todayCount = journalDataCache.filter(e => e.tanggal === todayStr).length;
            const monthCount = journalDataCache.filter(e => e.tanggal.startsWith(`${curYear}-${curMonth}`)).length;

            document.getElementById('stat-count-today').textContent = todayCount;
            document.getElementById('stat-count-month').textContent = monthCount;
        }

        function renderRecentDashboard() {
            const list = document.getElementById('home-recent-list');
            const recents = journalDataCache.slice(0, 3);
            if (recents.length === 0) {
                list.innerHTML = `<p class="text-center text-sm text-gray-400 py-4">Belum ada jurnal.</p>`;
                return;
            }
            list.innerHTML = '';
            recents.forEach(e => {
                const div = document.createElement('div');
                div.className = "flex items-center space-x-4";
                div.innerHTML = `
                    <div class="bg-indigo-50 p-3 rounded-2xl">
                        <div class="w-2 h-2 rounded-full bg-indigo-600"></div>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-sm font-bold text-gray-800">${e.kegiatan}</h4>
                        <p class="text-[10px] text-gray-400 font-medium">${e.tanggal}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderHistory() {
            const list = document.getElementById('journal-list-content');
            if(!list) return;
            const b = document.getElementById('filter-bulan').value;
            const t = document.getElementById('filter-tahun').value;
            
            const filtered = journalDataCache.filter(e => e.tanggal.startsWith(`${t}-${b}`));
            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center py-20"><p class="text-gray-400 text-sm font-medium">Tidak ada data untuk periode ini.</p></div>`;
                return;
            }

            list.innerHTML = '';
            filtered.forEach(e => {
                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-[28px] border border-gray-100 shadow-sm relative";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-[9px] font-black uppercase tracking-widest text-indigo-500 bg-indigo-50 px-2 py-1 rounded-lg">${e.kegiatan}</span>
                            <h4 class="text-lg font-bold text-gray-900 mt-2">${e.tanggal}</h4>
                        </div>
                        <button onclick="deleteJournal('${e.id}')" class="p-2 text-red-400 font-bold text-xs uppercase tracking-tighter">Hapus</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        window.deleteJournal = async (id) => {
            if (!confirm("Hapus jurnal ini?")) return;
            const userPath = `/artifacts/${appIdPrefix}/users/${firebaseUid}/jurnal_harian`;
            await deleteDoc(doc(db, userPath, id));
        };

        // --- Logika Ekspor ---
        function setupExportListeners() {
            const btnHtml = document.getElementById('export-html-button');
            const btnText = document.getElementById('export-text-button');

            btnHtml.onclick = () => {
                const b = document.getElementById('bulan-export').value;
                const t = document.getElementById('tahun-export').value;
                const data = journalDataCache.filter(e => e.tanggal.startsWith(`${t}-${b}`));
                
                if (data.length === 0) {
                    showAlert("Data Kosong", "Tidak ada jurnal untuk bulan " + b + " tahun " + t);
                    return;
                }

                let htmlContent = `<html><head><meta charset="UTF-8"><style>table { width: 100%; border-collapse: collapse; font-family: sans-serif; } th, td { border: 1px solid #ddd; padding: 12px; text-align: left; } th { background-color: #4f46e5; color: white; } h2 { text-align: center; color: #1e1b4b; }</style></head><body><h2>JURNAL HARIAN GURU: ${currentUserName.toUpperCase()}</h2><p>Periode Laporan: ${b}/${t}</p><table><thead><tr><th>Tanggal</th><th>Kegiatan</th><th>Detail Kegiatan</th></tr></thead><tbody>`;
                data.forEach(e => {
                    let detail = "-";
                    if(e.kegiatan === 'Mengajar') detail = `Kelas: ${e.kelasDiajar}, Jam: ${e.jamMulai}-${e.jamSelesai}, Materi: ${e.materiDiajar}, Absen: ${e.kehadiranPesertaDidik}`;
                    else if(e.kegiatan === 'Piket') detail = `Lokasi: ${e.lantai}`;
                    else if(e.kegiatan === 'Lainnya') detail = e.namaKegiatanLainnya;
                    htmlContent += `<tr><td>${e.tanggal}</td><td>${e.kegiatan}</td><td>${detail}</td></tr>`;
                });
                htmlContent += `</tbody></table></body></html>`;
                
                downloadFile(htmlContent, `Jurnal_${currentUserName}_${b}_${t}.html`, 'text/html');
            };

            btnText.onclick = () => {
                const b = document.getElementById('bulan-export').value;
                const t = document.getElementById('tahun-export').value;
                const data = journalDataCache.filter(e => e.tanggal.startsWith(`${t}-${b}`));

                if (data.length === 0) {
                    showAlert("Data Kosong", "Tidak ada jurnal untuk bulan " + b + " tahun " + t);
                    return;
                }

                let txtContent = `JURNAL HARIAN GURU - ${currentUserName}\nPeriode: ${b}/${t}\n\n`;
                data.forEach(e => {
                    txtContent += `Tanggal : ${e.tanggal}\nKegiatan: ${e.kegiatan}\nDetail  : ${e.kegiatan === 'Mengajar' ? e.materiDiajar : (e.kegiatan === 'Piket' ? e.lantai : e.namaKegiatanLainnya)}\n--------------------------------------------------\n`;
                });

                downloadFile(txtContent, `Jurnal_${currentUserName}_${b}_${t}.txt`, 'text/plain');
            };
        }

        // FUNGSI UNDUHAN ROBUST DENGAN FALLBACK
        function downloadFile(content, fileName, mimeType) {
            try {
                const blob = new Blob([content], { type: mimeType });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = fileName;
                a.style.display = 'none';
                document.body.appendChild(a);
                
                // Trigger menggunakan MouseEvent untuk kompatibilitas seluler
                const clickEvent = new MouseEvent('click', {
                    view: window,
                    bubbles: true,
                    cancelable: true
                });
                a.dispatchEvent(clickEvent);
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 300);

                showAlert("Proses Berhasil", "Permintaan unduhan laporan '" + fileName + "' telah dikirim ke browser.");
            } catch (err) {
                console.error("Download fail:", err);
                // FALLBACK: Buka di tab baru jika unduhan diblokir
                const newWindow = window.open();
                if (newWindow) {
                    newWindow.document.write(content);
                    newWindow.document.close();
                    showAlert("Info Unduhan", "Unduhan otomatis diblokir browser. Rekap dibuka di tab baru, silakan salin teks atau simpan halaman (Ctrl+S).");
                } else {
                    showAlert("Gagal", "Unduhan gagal dan pembukaan tab baru diblokir browser. Harap izinkan pop-up.");
                }
            }
        }

        document.getElementById('filter-bulan').onchange = renderHistory;
        document.getElementById('filter-tahun').onchange = renderHistory;

        start();
    </script>
</body>
</html>

